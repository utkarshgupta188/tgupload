<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TG Cloud Storage</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="container">
    <script src="./config.js"></script>
    <header>
      <h1 style="margin:0;">TG Cloud</h1>
      <div class="right" id="header-pass" style="display:none;">
        <label>Password: <input id="password" type="password" /></label>
      </div>
    </header>

    <section class="row card" id="upload-section" style="display:none;">
      <input type="file" id="file" />
      <button id="upload">Upload</button>
      <progress id="progress" value="0" max="100" style="display:none;"></progress>
      <span id="status" class="muted"></span>
    </section>

    <section class="row card" id="search-section" style="margin-top:1rem; display:none;">
      <input type="text" id="search" placeholder="Search by name" />
      <button id="refresh">Refresh</button>
    </section>

    <table id="files-table" style="display:none;">
      <thead>
        <tr><th>Name</th><th>Size</th><th>Actions</th></tr>
      </thead>
      <tbody id="files"></tbody>
    </table>

    <!-- Password modal -->
    <div class="modal-overlay" id="pw-modal">
      <div class="modal">
        <h2>Enter Password</h2>
        <p>Access to your storage is protected.</p>
        <input id="pw-input" type="password" placeholder="API password" style="width:100%;" />
        <div class="actions">
          <button id="pw-submit">Continue</button>
        </div>
        <div id="pw-error" class="muted" style="color:#fca5a5; display:none;">Wrong password, try again.</div>
      </div>
    </div>

  <script>
      // Determine API base. If served via a static server on 8080 or from file://, default to localhost:8000
      let API_BASE = window.API_BASE || location.origin;
      try {
        const fromFile = !location.origin || location.origin.startsWith('file://');
        const on8080 = location.port === '8080';
        if ((!window.API_BASE && (fromFile || on8080)) || API_BASE === 'null') {
          API_BASE = 'http://localhost:8000';
        }
      } catch (e) {
        API_BASE = window.API_BASE || 'http://localhost:8000';
      }

      function headers() {
        const pwd = document.getElementById('password').value;
        return { 'X-API-KEY': pwd };
      }

      function humanSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const units = ['B','KB','MB','GB','TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + units[i];
      }

      async function listFiles() {
        const q = document.getElementById('search').value.trim();
        const url = new URL(API_BASE + '/api/files');
        if (q) url.searchParams.set('q', q);
        let res;
        try {
          res = await fetch(url, { headers: headers() });
        } catch (err) {
          document.getElementById('status').textContent = 'Cannot reach API at ' + API_BASE + ': ' + (err && err.message ? err.message : err);
          return;
        }
        if (!res.ok) {
          const text = await res.text();
          document.getElementById('status').textContent = 'Error ' + res.status + ' from API: ' + text;
          return;
        }
        const data = await res.json();
        const tbody = document.getElementById('files');
        tbody.innerHTML = '';
        for (const row of data) {
          const tr = document.createElement('tr');
          const name = document.createElement('td'); name.textContent = row.name; tr.appendChild(name);
          const size = document.createElement('td'); size.textContent = humanSize(row.size || 0); tr.appendChild(size);
          const act = document.createElement('td');
          const a = document.createElement('a');
          a.textContent = 'Download';
          const pwd = document.getElementById('password').value;
          a.href = API_BASE + '/api/download/' + encodeURIComponent(row.file_id) + '?key=' + encodeURIComponent(pwd);
          a.target = '_blank';
          a.rel = 'noopener';
          act.appendChild(a); tr.appendChild(act);
          tbody.appendChild(tr);
        }
      }

      // Direct anchor navigation with target=_blank triggers browser download using Content-Disposition from the API.

      async function upload() {
        const file = document.getElementById('file').files[0];
        if (!file) { alert('Pick a file'); return; }
        const form = new FormData(); form.append('upload', file, file.name);

        const prog = document.getElementById('progress'); prog.style.display = '';
        const status = document.getElementById('status'); status.textContent = 'Uploadingâ€¦';

        // Use XHR to track progress (Fetch can with streams but XHR is simpler for progress)
        await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', API_BASE + '/api/upload');
          const h = headers(); for (const k in h) xhr.setRequestHeader(k, h[k]);
          xhr.upload.onprogress = (e) => { if (e.lengthComputable) { prog.value = (e.loaded / e.total) * 100; }};
          xhr.onload = () => { if (xhr.status >= 200 && xhr.status < 300) resolve(); else reject(new Error(xhr.statusText || 'Upload failed')); };
          xhr.onerror = () => reject(new Error('Network error'));
          xhr.send(form);
        });

        status.textContent = 'Uploaded'; prog.style.display = 'none'; prog.value = 0; document.getElementById('file').value = '';
        await listFiles();
      }

      function setAuthedUI(on) {
        document.getElementById('header-pass').style.display = on ? '' : 'none';
        document.getElementById('upload-section').style.display = on ? '' : 'none';
        document.getElementById('search-section').style.display = on ? '' : 'none';
        document.getElementById('files-table').style.display = on ? '' : 'none';
      }

      async function tryAuthAndLoad(pwd) {
        // quick auth probe
        let ok = false;
        try {
          const r = await fetch(API_BASE + '/api/health', { headers: { 'X-API-KEY': pwd } });
          ok = r.ok;
        } catch (_) { ok = false; }
        if (!ok) return false;
        // set into header input for subsequent calls
        document.getElementById('password').value = pwd;
        setAuthedUI(true);
        await listFiles();
        return true;
      }

      // Modal wiring
      const modal = document.getElementById('pw-modal');
      const pwInput = document.getElementById('pw-input');
      const pwError = document.getElementById('pw-error');
      const pwSubmit = document.getElementById('pw-submit');

      pwSubmit.addEventListener('click', async () => {
        const pwd = pwInput.value.trim();
        pwError.style.display = 'none';
        if (!pwd) { pwError.textContent = 'Please enter a password.'; pwError.style.display = ''; return; }
        const ok = await tryAuthAndLoad(pwd);
        if (ok) { modal.style.display = 'none'; }
        else { pwError.textContent = 'Wrong password or server unreachable.'; pwError.style.display = ''; }
      });
      pwInput.addEventListener('keydown', async (e) => { if (e.key === 'Enter') { pwSubmit.click(); }});

      // Keep the inline header password field in sync if changed later
      document.getElementById('password').addEventListener('change', listFiles);
      document.getElementById('upload').onclick = upload;
      document.getElementById('refresh').onclick = listFiles;
      document.getElementById('search').oninput = () => { listFiles(); };

      // Show modal on load
      setAuthedUI(false);
      pwInput.focus();
    </script>
    </div>
  </body>
</html>
